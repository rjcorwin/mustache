<!DOCTYPE HTML>
<html>
	<head>
		<style type="text/css">
			body {
				margin: 0px;
				padding: 0px;
			}

			#myCanvas {
				position: absolute;
				z-index: 1;
				background-color: #FFFFFF
			}

			#about {
				position: absolute;
				bottom: 10px;
				left: 10px;
				z-index: 4
			}

			#help {
				font-size: 25px;
				color: #FFFFFF;
				right: 10px;
				top: 10px;
				position: absolute;
				z-index: 3;
				background-color: #9FC1CA;
				opacity: 0.82
			}

			#info {
				color: #888888;
				font-size: 20px;
				top: 10px;
				left: 10px;
				position: absolute;
				z-index: 2;
			}

		</style>

		<script type="text/javascript">function Vector2(e,t){if(e)this.x=e;else this.x=0;if(t)this.y=t;else this.y=1*this.x;this.normalize=function(){var e=this.x*this.x+this.y*this.y;var t=1/Math.sqrt(e);this.x*=t;this.y*=t;return this};this.getNormalized=function(){var e=new Vector2(this.x,this.y);return e.normalize()};this.invert=function(){this.x*=-1;this.y*=-1;return this};this.mult=function(e){this.x*=e;this.y*=e;return this};this.divide=function(e){this.x/=e;this.y/=e;return this};this.add=function(e){this.x+=e.x;this.y+=e.y};this.zero=function(){return new Vector3(0,0)}}function Node2D(e,t,n){this.m=n;this.p=new Vector2(e,t);this.a=new Vector2(0,0);this.v=new Vector2(0,0);this.update=function(){this.v.add(this.a);this.p.add(this.v);this.v.mult(.97);this.a.mult(.3)};this.getMass=function(){return this.m};this.setMass=function(e){if(e<=0)return;this.m=e}}function Spring2D(e,t,n,r){this.b=.03;this.node1=e;this.node2=t;this.isString=false;if(!r)this.k=-1;else this.k=r;if(n)this.d=n;else this.d=VecOp.distanceV2(e.p,t.p);this.update=function(){var e=this.node1;var t=this.node2;var n=this.k;var r=this.d;var i=this.b;var s=VecOp.distanceV2(e.p,t.p);if(this.isString&&s<this.d)return;var o=VecOp.subV2(t.p,e.p).normalize();var u=VecOp.subV2(e.p,t.p).normalize();var a=VecOp.subV2(e.v,t.v);var f=VecOp.subV2(t.v,e.v);var l=-n*(s-r)*(o.x/s)-i*a.x;var c=-n*(s-r)*(o.y/s)-i*a.y;var h=-n*(s-r)*(u.x/s)-i*f.x;var p=-n*(s-r)*(u.y/s)-i*f.y;e.a.x+=l/e.m;e.a.y+=c/e.m;t.a.x+=h/t.m;t.a.y+=p/t.m};this.toggleString=function(){this.isString=!this.isString};this.setStringMode=function(e){this.isString=e};this.getStiffness=function(){return this.k};this.setStiffness=function(e){this.k=e};this.getRest=function(){var e=this.node1;var t=this.node2;var n=VecOp.distanceV2(e.p,t.p);return this.d/n}}function Game(e,t,n,r,i){function b(){m=3;g=false;y=false;d=null;v=null;p.clear();h.clear();var e=GeometryGenerator.createPendulum(30,180,100,100,260,1,50,-m);var t=GeometryGenerator.createMesh(200,20,5,5,60,60,1,50,50,-m);var n=GeometryGenerator.createCircle(700,300,100,6,1,1,80,60,-m);h=h.concat(e.Nodes,n.Nodes,t.Nodes);p=p.concat(e.Springs,n.Springs,t.Springs)}function C(e,t,n){if(e<t)return t;if(e>n)return n;return e}function k(e){if(d){var t=0;if("wheelDelta"in e)t=-event.wheelDelta/50;else t=e.detail/1.5;d.setMass(d.getMass()+ -t)}}function L(e,t){for(var n=0;n<h.length;n++){var r=VecOp.distanceV2(h[n].p,new Vector2(e,t));if(r<20)return h[n]}return null}function A(){var e=new Date;return e.getTime()}function O(){if(!y){for(var e=0;e<p.length;e++){p[e].update()}for(var e=0;e<h.length;e++){h[e].update()}}if(T&&d&&w){d.p.x=T.x;d.p.y=T.y}if(u){if(d)u.innerHTML="Mass: "+d.getMass().toFixed(2);else u.innerHTML="Mass: -"}if(f)f.innerHTML="Stiffness: "+m.toFixed(2);if(a)a.innerHTML="Type: "+(g?"Strings":"Springs")}function M(){c.clearRect(0,0,o.width,o.height);for(var e=0;e<p.length;e++){var t=p[e].node1;var n=p[e].node2;drawLib.drawLine(c,t.p,n.p,6*p[e].getRest(),y?"#888888":"null")}for(var e=0;e<h.length;e++){var r=h[e].p;drawLib.drawCircle(c,r.x,r.y,10)}if(d)drawLib.drawCircle(c,d.p.x,d.p.y,15);if(v){drawLib.drawLine(c,v.p,T,3,"#FFFF00");drawLib.drawCircle(c,T.x,T.y,10)}}var o=e;var u=t;var a=n;var f=r;var l=i;var c=o.getContext("2d");var h=new Array;var p=new Array;var d;var v;var m=3;var g=false;var y=false;b();var w=false;var E=false;var S=1;var x=null;var T=new Vector2;var N=0;document.addEventListener("keypress",function(e){var t=e.which;if(t==32){g=!g;for(var n=0;n<p.length;n++){p[n].setStringMode(g)}}else if(t==1581||t==112){y=!y}},false);document.addEventListener("keydown",function(e){var t=e.which;if(t==38){m+=.02;m=C(m,.5,3);for(var n=0;n<p.length;n++){p[n].setStiffness(-m)}}else if(t==40){m-=.02;m=C(m,.5,3);for(var n=0;n<p.length;n++){p[n].setStiffness(-m)}}else if(t==49||t==91){if(!l)return;var r=l.style.display;if(r=="none")r="block";else r="none";l.style.display=r}},true);window.addEventListener("mousewheel",k,false);window.addEventListener("DOMMouseScroll",k,false);o.onmousedown=function(e){var t=o.relMouseCoords(e);T=new Vector2(t.x,t.y);var n=L(t.x,t.y);if(e.button==0){if(n&&A()-N<500){for(var r=0;r<p.length;r++){s=p[r];if(s.node1==n||s.node2==n){p.remove(r);r--}}h.remove(h.indexOf(n));d=null;return}d=n;w=true;N=A()}else if(e.button==2){if(n){v=n;E=true}x=new Vector2(T.x,T.y)}};o.onmouseup=function(e){var t=o.relMouseCoords(e);if(e.button==2){var n=L(t.x,t.y);if(!v&&!n){n=new Node2D(T.x,T.y,S);h.push(n)}else if(v&&v!=n){if(!n)n=new Node2D(t.x,t.y,S);h.push(n);var r=VecOp.distanceV2(n.p,v.p);var i=new Spring2D(v,n,.8*r,-m);i.setStringMode(g);p.push(i)}v=null}w=false;E=false;T=null};o.onmousemove=function(e){var t=o.relMouseCoords(e);T=new Vector2(t.x,t.y)};window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();(function _(){requestAnimFrame(_);O();M()})();Array.prototype.remove=function(e,t){var n=this.slice((t||e)+1||this.length);this.length=e<0?this.length+e:e;return this.push.apply(this,n)}}var Util={getPageWidth:function(){var e=0;if(self.innerHeight){e=self.innerWidth}else if(document.documentElement&&document.documentElement.clientHeight){e=document.documentElement.clientWidth}else if(document.body){e=document.body.clientWidth}return e},getPageHeight:function(){var e=0;if(self.innerHeight){e=self.innerHeight}else if(document.documentElement&&document.documentElement.clientHeight){e=document.documentElement.clientHeight}else if(document.body){e=document.body.clientHeight}return e}};var VecOp={distanceV2:function(e,t){num2=e.x-t.x;num=e.y-t.y;num3=num2*num2+num*num;return Math.sqrt(num3)},subV2:function(e,t){var n=e.x-t.x;var r=e.y-t.y;return new Vector2(n,r)}};var GeometryGenerator={createPendulum:function(e,t,n,r,i,s,o,u){var a=new Array;var f=new Array;var l=new Node2D(e,t,n);var c=new Node2D(r,i,s);a.push(l);a.push(c);f.push(new Spring2D(l,c,o,u));return{Nodes:a,Springs:f}},createCircle:function(e,t,n,r,i,s,o,u,a){var f=new Array;var l=new Array;var c=new Node2D(e,t,i);var h=Math.PI*2/r;for(var p=0;p<r;p++){var d=p*h;var v=new Node2D(e+n*Math.sin(d),t+n*Math.cos(d),s);f.push(v)}for(var p=0;p<f.length-1;p++){var m=new Spring2D(f[p],f[p+1],u,a);l.push(m)}for(var p=0;p<f.length;p++){spr2=new Spring2D(f[p],c,o,a);l.push(spr2)}var g=new Spring2D(f[0],f[f.length-1],u,a);l.push(g);f.push(c);return{Nodes:f,Springs:l}},createMesh:function(e,t,n,r,i,s,o,u,a,f){var l=new Array;var c=new Array;for(var h=1;h<=r;h++){for(var p=1;p<=n;p++){var d=new Node2D(e+p*i,t+h*s,o);l.push(d)}}for(var v=0;v<n-1;v++){for(var m=0;m<r;m++){var g=new Spring2D(l[v+n*m],l[v+1+n*m],u,f);c.push(g)}}for(var v=0;v<r-1;v++){for(var m=0;m<n;m++){var y=new Spring2D(l[v*n+m],l[(v+1)*n+m],u,f);c.push(y)}}for(var h=0;h<r-1;h++){for(var p=0;p<n-1;p++){var b=new Spring2D(l[p+h*n],l[p+(h+1)*n+1],a,f);c.push(b)}}for(var h=0;h<r-1;h++){for(var p=1;p<n;p++){var b=new Spring2D(l[p+h*n],l[p+(h+1)*n-1],a,f);c.push(b)}}return{Nodes:l,Springs:c}}};var drawLib={drawLine:function(e,t,n,r,i){if(!i)i="green";var s=VecOp.distanceV2(t,n);if(s<10)return;e.beginPath();e.lineWidth=r;e.strokeStyle=i;e.moveTo(t.x,t.y);e.lineTo(n.x,n.y);e.stroke()},drawCircle:function(e,t,n,r,i){if(!i)i="#007700";e.beginPath();e.arc(t,n,r,0,2*Math.PI,false);e.fillStyle="#33AA00";e.fill();e.lineWidth=5;e.strokeStyle=i;e.stroke()}};onerror=function(e,t,n){alert(e+"\n"+t+"\n"+n);return true};HTMLCanvasElement.prototype.relMouseCoords=function(e){var t=0;var n=0;var r=0;var i=0;var s=this;do{t+=s.offsetLeft-s.scrollLeft;n+=s.offsetTop-s.scrollTop}while(s=s.offsetParent);r=e.pageX-t;i=e.pageY-n;return{x:r,y:i}};Array.prototype.clear=function(){this.splice(0,this.length)}</script>

		<title>Spring Lab</title>
	</head>
	<body style="background-color: #AABBCC">
		<div id = "help">
			<b>Mouse Left button  :</b> Move node
			<br/>
			<b>Mouse double click :</b> Delete node
			<br/>
			<b>Mouse right button :</b> Create node
			<br/>
			<b>Mouse right drag    :</b> Connect ndoes
			<br/>
			<b>Mouse Wheel :</b> Change mass
			<br/>
			<br/>
			<b>Up\Down :</b> Change stiffness
			<br/>
			<b>Space :</b> Toggle strings mode
			<br/>
			<b>P :</b> Pause\Resume
			<br/>
			<b>F5 :</b> Reset all
			<br/>
			<b>Num1 :</b> Show\hide help
			<br/>
		</div>
		<div  id="info">
			<div id="mass">
				Mass: -
			</div>
			<div id="type">
				Type: Springs
			</div>
			<div id="stiffness">
				Stiffness: 0
			</div>
		</div>
		<canvas id="myCanvas" width="800" height="600"></canvas>

		<div id = "about">
			SpringsLab by <b>Hisham Ghosheh</b>, JS Version, <a  href="http://ghoshehsoft.wordpress.com/2013/03/02/simple-spring-physics/" target="_blank">http://ghoshehsoft.wordpress.com/2013/03/02/simple-spring-physics/</a>
		</div>

		<script type="text/javascript">
			document.oncontextmenu = function() {
				return false;
			}
			var canvas = document.getElementById('myCanvas');
			var massDiv = document.getElementById('mass');
			var typeDiv = document.getElementById('type');
			var stiffnessDiv = document.getElementById('stiffness');
			var helpDiv = document.getElementById('help');

			canvas.width = Util.getPageWidth();
			canvas.height = Util.getPageHeight();

			// Creating game, divs are optional to pass
			var g = new Game(canvas, massDiv, typeDiv, stiffnessDiv, helpDiv);
		</script>
	</body>
</html>